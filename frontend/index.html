<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Athena | Sess√£o de Estudo</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body class="bg-slate-900 text-slate-100 font-sans antialiased">

<div 
    x-data="studySession()" 
    x-init="init()" 
    class="max-w-4xl mx-auto min-h-screen flex flex-col p-6"
>

    <!-- HEADER -->
    <header class="flex justify-between items-center mb-12">
        <div>
            <h1 class="text-xl font-bold tracking-tight text-emerald-400">
                ATHENA_BRAIN
            </h1>
            <p 
                class="text-xs text-slate-400 uppercase tracking-widest"
                x-text="'Plano: ' + (plan?.id || 'Carregando‚Ä¶')"
            ></p>
        </div>

        <div class="text-right">
            <span class="text-xs block text-slate-500 mb-1">
                N√çVEL DE FOCO
            </span>
            <div 
                class="px-3 py-1 bg-emerald-500/10 border border-emerald-500/20 
                       text-emerald-400 text-xs font-mono rounded"
                x-text="plan?.focus_level ?? '--'"
            ></div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="flex-grow flex flex-col justify-center items-center text-center">

        <!-- LOADING -->
        <template x-if="loading">
            <div class="animate-pulse text-slate-500 font-mono">
                SINCRONIZANDO GRAFO DE CONHECIMENTO‚Ä¶
            </div>
        </template>

        <!-- SESSION COMPLETED -->
        <template x-if="!loading && session.completed">
            <div class="space-y-6">
                <h2 class="text-3xl font-light text-emerald-400">
                    Sess√£o conclu√≠da
                </h2>
                <p class="text-slate-400 max-w-md mx-auto">
                    O Athena Brain est√° recalculando seus intervalos ideais
                    e ajustando o grafo cognitivo.
                </p>
                <button 
                    @click="window.location.reload()"
                    class="mt-4 px-6 py-3 border border-emerald-500/30 
                           hover:bg-emerald-500/10 rounded-lg transition"
                >
                    Iniciar nova sess√£o
                </button>
            </div>
        </template>

        <!-- ACTIVE NODE -->
        <template x-if="!loading && currentNode && !session.completed">
            <div class="w-full space-y-10">
                <div class="space-y-2">
                    <span class="text-emerald-500 font-mono text-sm">
                        [MICROCONCEITO ATUAL]
                    </span>
                    <h2 
                        class="text-4xl font-light leading-tight"
                        x-text="currentNode"
                    ></h2>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pt-12">

                    <button 
                        @click="submitReview(1)"
                        class="p-4 border border-slate-700 
                               hover:border-red-500/50 hover:bg-red-500/5 
                               transition rounded-lg group"
                    >
                        <span class="block text-xl">üîÑ</span>
                        <span class="text-xs text-slate-500 group-hover:text-red-400">
                            REPETIR (1)
                        </span>
                    </button>

                    <button 
                        @click="submitReview(2)"
                        class="p-4 border border-slate-700 
                               hover:border-orange-500/50 hover:bg-orange-500/5 
                               transition rounded-lg group"
                    >
                        <span class="block text-xl">‚è≥</span>
                        <span class="text-xs text-slate-500 group-hover:text-orange-400">
                            DIF√çCIL (2)
                        </span>
                    </button>

                    <button 
                        @click="submitReview(3)"
                        class="p-4 border border-slate-700 
                               hover:border-emerald-500/50 hover:bg-emerald-500/5 
                               transition rounded-lg group"
                    >
                        <span class="block text-xl">‚úÖ</span>
                        <span class="text-xs text-slate-500 group-hover:text-emerald-400">
                            BOM (3)
                        </span>
                    </button>

                    <button 
                        @click="submitReview(4)"
                        class="p-4 border border-slate-700 
                               hover:border-blue-500/50 hover:bg-blue-500/5 
                               transition rounded-lg group"
                    >
                        <span class="block text-xl">üöÄ</span>
                        <span class="text-xs text-slate-500 group-hover:text-blue-400">
                            F√ÅCIL (4)
                        </span>
                    </button>

                </div>
            </div>
        </template>
    </main>

    <!-- FOOTER -->
    <footer 
        class="mt-auto pt-12 border-t border-slate-800 
               flex justify-between text-[10px] text-slate-500 
               font-mono uppercase tracking-tighter"
    >
        <div>
            <span 
                x-text="'Dura√ß√£o Estimada: ' + (plan?.estimated_duration_minutes ?? 0) + 'min'"
            ></span>
        </div>
        <div>
            <span 
                x-text="'N√≥s Restantes: ' + ((plan?.knowledge_nodes?.length ?? 0) - session.index)"
            ></span>
        </div>
    </footer>
</div>

<!-- LOGIC -->
<script>
function studySession() {
    return {
        loading: true,
        plan: null,

        session: {
            index: 0,
            completed: false,
            startedAt: null,
        },

        get currentNode() {
            return this.plan?.knowledge_nodes?.[this.session.index] ?? null;
        },

        async init() {
            this.session.startedAt = Date.now();
            this.bindShortcuts();

            try {
                const response = await fetch('/api/study/generate', {
                    method: 'POST',
                });
                if (!response.ok) throw new Error('Erro ao gerar plano');
                this.plan = await response.json();
            } catch (err) {
                console.error('Falha ao carregar plano:', err);
            } finally {
                this.loading = false;
            }
        },

        async submitReview(grade) {
            if (!this.currentNode) return;

            const nodeId = this.currentNode;
            const previousIndex = this.session.index;

            // Optimistic UI
            this.advance();

            try {
                const response = await fetch(`/api/study/review/${nodeId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ grade }),
                });
                if (!response.ok) throw new Error('Falha ao salvar review');
            } catch (err) {
                console.error(err);
                // rollback
                this.session.index = previousIndex;
                this.session.completed = false;
            }
        },

        advance() {
            if (this.session.index < this.plan.knowledge_nodes.length - 1) {
                this.session.index++;
            } else {
                this.session.completed = true;
            }
        },

        bindShortcuts() {
            window.addEventListener('keydown', (e) => {
                const map = { '1': 1, '2': 2, '3': 3, '4': 4 };
                if (map[e.key]) {
                    e.preventDefault();
                    this.submitReview(map[e.key]);
                }
            });
        },
    };
}
</script>

</body>
</html>
